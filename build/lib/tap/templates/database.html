<%inherit file="base.html" />

<%block name="pagecontent">
<div class="row" style="height:53px">
    <a data-toggle="modal" href="#write" data-target="#myModal" class="btn-new-mail pull-right">
		<span class="btn btn-primary no-border">
			<i class="ace-icon fa fa-plus bigger-130"></i>
			<span class="bigger-110">添加</span>
		</span>
	</a>

	<div class="btn-group pull-right" style="margin:9px 5px 0 0;">
		<button data-toggle="dropdown" class="btn btn-primary btn-white dropdown-toggle">
			操作 <i class="ace-icon fa fa-angle-down icon-on-right"></i>
		</button>
		<ul class="dropdown-menu">
			<li> <a href="#">开始编辑</a> </li>
			<li> <a href="#">停止编辑</a> </li>
			<li class="divider"></li>
			<li> <a href="#">删除</a> </li>
		</ul>
	</div>

</div>

<div class="row">
	<table class="table table-hover table-striped">
		<thead>
		<tr>
			<th>名称</th>
			<th>DB类型</th>
			<th>创建者</th>
			<th>时间</th>
			<th>连接字符串</th>
		</tr>
		</thead>
		<tbody>
		%for conn in conns:
		<tr>
			<td><a href="/management/database/${conn.id}">${conn.name}</a></td>
			<td>${conn.dbtype}</td>
			<td>${conn.user_create.name}</td>
			<td>${conn.created}</td>
			<td>${conn.connstring}</td>
			<td style="display:none">${conn.description}</td>
		</tr>
		%endfor
		</tbody>
	</table>
</div>

</%block>

<%block name="modal">
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">创建数据库连接</h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" id="new-conn" role="form">
			<!-- #section:elements.form -->
			<div class="form-group">
				<label class="col-sm-3 control-label no-padding-right" for="form-field-1">
					名称
				</label>
				<div class="col-sm-9">
					<input type="text" id="form-field-1" name="name" placeholder="名称" class="col-xs-10">
				</div>
			</div>

			<div class="form-group">
				<label class="col-sm-3 control-label no-padding-right" for="form-field-1">
					DB类型
				</label>
				<div class="col-sm-9">
					<select name="dbtype" id="form-field-1" placeholder="" class="chosen-select col-xs-10">
						<option>选择DB类型</option>
						<option>ORACLE</option>
						<option>MSSQL</option>
						<option>MYSQL</option>
						<option>PGSQL</option>
                    </select>
				</div>
			</div>

			<div class="form-group">
				<label class="col-sm-3 control-label no-padding-right" for="form-field-1">
					连接字符串
				</label>
				<div class="col-sm-9">
					<input type="text" id="form-field-1" name="connstring" placeholder="连接字符串" class="col-xs-10">
				</div>
			</div>

			<div class="form-group">
				<label class="col-sm-3 control-label no-padding-right" for="form-field-1">
					说明
				</label>
				<div class="col-sm-9">
					<textarea type="text" id="form-field-1" name="description" placeholder="说明" class="col-xs-10"></textarea>
				</div>
			</div>

			<div class="form-group">
				<label class="col-sm-3 control-label no-padding-right" for="form-field-1">
					选项
				</label>
				<div class="col-sm-9">
					<textarea type="text" id="form-field-1" name="options" placeholder="其它配置项" class="col-xs-10"></textarea>
				</div>
			</div>
			<input type="hidden" id="submit-action" name="action" value=""/>

        </form>
      </div>
      <div class="modal-footer">
        <button id="test-conn" type="button" class="btn btn-default">测试连接</button>
        <button id="save-conn" type="button" class="btn btn-primary">保存</button>
      </div>
    </div>
  </div>
</div>
</%block>

<%block name="jsblock">
<script>
function testConn(){
	$('#test-conn').attr('disable', true);
	$('#save-conn').attr('disable', true);
	$('#submit-action').val('conntest');
	var paras = $('#new-conn').serialize();
	$.getJSON('/management/action', paras, function(response){
		if(response.success == 1){
			alert("连接成功!");
        }
		else {
			alert(response.message);
		}
        $('#test-conn').removeAttr('disable' );
        $('#save-conn').removeAttr('disable');
	})
}

function saveConn(){
	$('#test-conn').attr('disable', true);
	$('#save-conn').attr('disable', true);
	$('#submit-action').val('connsave');
	var paras = $('#new-conn').serialize();
	$.getJSON('/management/action', paras, function(response){
		if(response.success == 1){
			window.location.reload();
        }
		else {
			alert(response.message);
            $('#test-conn').removeAttr('disable' );
            $('#save-conn').removeAttr('disable');
		}
	})
}
$(document).ready(function(){
	$('#test-conn').click(testConn);
	$('#save-conn').click(saveConn);
})
</script>
</%block>